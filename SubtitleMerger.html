<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subtitle Merger - Emby Plugin</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2634 50%, #0d1117 100%);
            color: #e6eaf0;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #00a4dc;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        h1 span { font-size: 0.4em; color: #4CAF50; }
        h2 {
            color: #9fb0c2;
            font-size: 1.1em;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #2b3743;
        }
        .card {
            background: rgba(23, 28, 34, 0.9);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        select, input, button {
            font-family: inherit;
            font-size: 14px;
        }
        select {
            width: 100%;
            padding: 12px;
            background: #0f1419;
            color: #e6eaf0;
            border: 1px solid #2b3743;
            border-radius: 8px;
            cursor: pointer;
        }
        select:focus { border-color: #00a4dc; outline: none; }
        .sub-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .sub-col {
            flex: 1;
            min-width: 280px;
        }
        .sub-col label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .sub-col.primary label { color: #4CAF50; }
        .sub-col.secondary label { color: #2196F3; }
        .sub-col.primary select { border-color: #4CAF50; }
        .sub-col.secondary select { border-color: #2196F3; }
        .options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        .options label {
            color: #888;
            font-size: 0.9em;
        }
        .options select, .options input {
            margin-top: 5px;
            padding: 8px;
        }
        .options input[type="number"] {
            width: 80px;
            background: #0f1419;
            color: #e6eaf0;
            border: 1px solid #2b3743;
            border-radius: 5px;
        }
        button.primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        button.primary:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        button.secondary {
            background: #2b3743;
            color: #9fb0c2;
            border: 1px solid #3d4f5f;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
        }
        button.secondary:hover { background: #3d4f5f; }
        .preview {
            padding: 15px;
            background: rgba(0, 164, 220, 0.1);
            border-left: 4px solid #00a4dc;
            border-radius: 8px;
            margin: 20px 0;
        }
        .result {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .result.success {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid #4CAF50;
        }
        .result.error {
            background: rgba(244, 67, 54, 0.2);
            border-left: 4px solid #f44336;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            font-size: 0.85em;
            color: #888;
        }
        .status.ok { color: #4CAF50; }
        .status.error { color: #f44336; }
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #2b3743;
            border-top-color: #00a4dc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .movie-info {
            font-size: 0.9em;
            color: #888;
            margin-top: 8px;
            font-family: monospace;
        }
        .sub-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sub-item.text { border-left: 3px solid #4CAF50; }
        .sub-item.image { border-left: 3px solid #ff9800; }
        .badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .badge.text { background: #4CAF50; color: white; }
        .badge.image { background: #ff9800; color: white; }
        .badge.ext { background: #2196F3; color: white; }
        .badge.int { background: #666; color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üé¨ Subtitle Merger <span>v4.1 - Standalone</span></h1>
            <div id="status" class="status">
                <div class="loader"></div>
                <span>Connexion √† Emby...</span>
            </div>
        </div>

        <!-- √âtape 1: Film -->
        <div class="card">
            <h2>1. S√©lectionner un film</h2>
            <select id="movieSelect">
                <option value="">‚Äî Chargement des films... ‚Äî</option>
            </select>
            <div id="movieInfo" class="movie-info"></div>
        </div>

        <!-- √âtape 2: Sous-titres -->
        <div id="subtitlesCard" class="card hidden">
            <h2>2. S√©lectionner les sous-titres √† fusionner</h2>
            <div id="subtitlesList"></div>
            
            <div class="sub-row" style="margin-top: 20px;">
                <div class="sub-col primary">
                    <label>‚Üë Sous-titre HAUT (langue 1):</label>
                    <select id="sub1Select">
                        <option value="">‚Äî S√©lectionner ‚Äî</option>
                    </select>
                </div>
                <div class="sub-col secondary">
                    <label>‚Üì Sous-titre BAS (langue 2):</label>
                    <select id="sub2Select">
                        <option value="">‚Äî S√©lectionner ‚Äî</option>
                    </select>
                </div>
            </div>

            <div class="options">
                <div>
                    <label>Mode de fusion:</label><br>
                    <select id="mergeMode">
                        <option value="all">Tous les sous-titres</option>
                        <option value="overlapping">Chevauchements uniquement</option>
                        <option value="primary">Priorit√© langue 1</option>
                    </select>
                </div>
                <div>
                    <label>Tol√©rance (ms):</label><br>
                    <input type="number" id="tolerance" value="700" min="0" max="5000">
                </div>
            </div>
        </div>

        <!-- √âtape 3: Fusion -->
        <div id="mergeCard" class="card hidden">
            <h2>3. Fusionner</h2>
            <div id="preview" class="preview">
                S√©lectionnez deux sous-titres diff√©rents pour activer la fusion.
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <button id="btnMerge" class="primary" disabled>üîÄ Fusionner les sous-titres</button>
                <button id="btnRefresh" class="secondary">üîÑ Rafra√Æchir</button>
            </div>
            <div id="result"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_KEY = 'a482e26698584ef8a83d6ff49c0d8676';
        const USER_ID = 'e69b7a5d73a943b4918712599f79905e';
        const EMBY_URL = 'http://localhost:8096';

        let movies = [];
        let currentMovie = null;
        let subtitles = [];

        // Initialisation
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            await checkStatus();
            await loadMovies();
            
            document.getElementById('movieSelect').addEventListener('change', onMovieChange);
            document.getElementById('sub1Select').addEventListener('change', updatePreview);
            document.getElementById('sub2Select').addEventListener('change', updatePreview);
            document.getElementById('btnMerge').addEventListener('click', doMerge);
            document.getElementById('btnRefresh').addEventListener('click', () => location.reload());
        }

        async function checkStatus() {
            const statusEl = document.getElementById('status');
            try {
                const res = await fetch(`${EMBY_URL}/EmbySubtitleMerger/Status?api_key=${API_KEY}`);
                const data = await res.json();
                
                if (data.FfmpegAvailable) {
                    statusEl.className = 'status ok';
                    statusEl.innerHTML = `‚úÖ Connect√© √† Emby | FFmpeg: ${data.FfmpegVersion?.split(' ')[2] || 'OK'} | Plugin: v${data.PluginVersion}`;
                } else {
                    statusEl.className = 'status error';
                    statusEl.innerHTML = '‚ö†Ô∏è FFmpeg non disponible';
                }
            } catch (e) {
                statusEl.className = 'status error';
                statusEl.innerHTML = '‚ùå Impossible de se connecter √† Emby. V√©rifiez que le serveur est d√©marr√©.';
            }
        }

        async function loadMovies() {
            const select = document.getElementById('movieSelect');
            try {
                const url = `${EMBY_URL}/emby/Users/${USER_ID}/Items?IncludeItemTypes=Movie&Recursive=true&SortBy=SortName&Fields=Path,MediaStreams&api_key=${API_KEY}`;
                const res = await fetch(url);
                const data = await res.json();
                
                movies = data.Items || [];
                select.innerHTML = '<option value="">‚Äî S√©lectionner un film (' + movies.length + ') ‚Äî</option>';
                
                movies.forEach((m, i) => {
                    const year = m.ProductionYear ? ` (${m.ProductionYear})` : '';
                    const subs = (m.MediaStreams || []).filter(s => s.Type === 'Subtitle').length;
                    const subInfo = subs > 0 ? ` - ${subs} sous-titre(s)` : ' - Pas de sous-titres';
                    
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = m.Name + year + subInfo;
                    select.appendChild(opt);
                });
            } catch (e) {
                select.innerHTML = '<option value="">Erreur: ' + e.message + '</option>';
            }
        }

        async function onMovieChange() {
            const idx = parseInt(this.value);
            const subtitlesCard = document.getElementById('subtitlesCard');
            const mergeCard = document.getElementById('mergeCard');
            const movieInfo = document.getElementById('movieInfo');
            
            if (isNaN(idx) || idx < 0) {
                subtitlesCard.classList.add('hidden');
                mergeCard.classList.add('hidden');
                movieInfo.textContent = '';
                return;
            }
            
            currentMovie = movies[idx];
            movieInfo.textContent = 'üìÅ ' + (currentMovie.Path || '').split(/[\\/]/).pop();
            
            // Charger les sous-titres d√©taill√©s
            await loadSubtitles(currentMovie.Id);
            
            subtitlesCard.classList.remove('hidden');
            mergeCard.classList.remove('hidden');
        }

        async function loadSubtitles(itemId) {
            const listEl = document.getElementById('subtitlesList');
            const sub1 = document.getElementById('sub1Select');
            const sub2 = document.getElementById('sub2Select');
            
            try {
                const url = `${EMBY_URL}/emby/Users/${USER_ID}/Items/${itemId}?Fields=MediaStreams,Path&api_key=${API_KEY}`;
                const res = await fetch(url);
                const data = await res.json();
                
                subtitles = (data.MediaStreams || []).filter(s => s.Type === 'Subtitle');
                
                // Afficher la liste
                if (subtitles.length === 0) {
                    listEl.innerHTML = '<p style="color:#ff6b6b;">Aucun sous-titre trouv√© dans ce fichier.</p>';
                    sub1.innerHTML = sub2.innerHTML = '<option value="">Aucun sous-titre</option>';
                    return;
                }
                
                let html = '';
                subtitles.forEach(s => {
                    const isText = s.IsTextSubtitleStream || ['srt','ass','ssa','subrip','webvtt','mov_text'].includes((s.Codec||'').toLowerCase());
                    const typeClass = isText ? 'text' : 'image';
                    const typeBadge = isText ? '<span class="badge text">TXT</span>' : '<span class="badge image">IMG</span>';
                    const locBadge = s.IsExternal ? '<span class="badge ext">EXT</span>' : '<span class="badge int">INT</span>';
                    
                    html += `<div class="sub-item ${typeClass}">
                        ${typeBadge} ${locBadge}
                        <span>#${s.Index} ${(s.Language||'und').toUpperCase()} (${s.Codec})</span>
                        ${s.Title ? `<span style="color:#666;">- ${s.Title}</span>` : ''}
                        ${!isText ? '<span style="color:#ff9800;font-size:0.8em;">(n√©cessite OCR)</span>' : ''}
                    </div>`;
                });
                listEl.innerHTML = html;
                
                // Remplir les selects (seulement les sous-titres texte)
                const textSubs = subtitles.filter(s => 
                    s.IsTextSubtitleStream || ['srt','ass','ssa','subrip','webvtt','mov_text'].includes((s.Codec||'').toLowerCase())
                );
                
                const options = '<option value="">‚Äî S√©lectionner ‚Äî</option>' + 
                    textSubs.map(s => {
                        const label = `#${s.Index} ${(s.Language||'und').toUpperCase()} (${s.Codec})${s.Title ? ' - '+s.Title : ''}`;
                        return `<option value="${s.Index}">${label}</option>`;
                    }).join('');
                
                sub1.innerHTML = options;
                sub2.innerHTML = options;
                
                if (textSubs.length === 0) {
                    sub1.innerHTML = sub2.innerHTML = '<option value="">Aucun sous-titre texte</option>';
                    document.getElementById('preview').innerHTML = 
                        '<span style="color:#ff9800;">‚ö†Ô∏è Ce film n\'a que des sous-titres image (PGS/VobSub). ' +
                        'Convertissez-les en SRT avec SubtitleEdit ou ajoutez des fichiers .srt externes.</span>';
                }
                
            } catch (e) {
                listEl.innerHTML = '<p style="color:#ff6b6b;">Erreur: ' + e.message + '</p>';
            }
            
            updatePreview();
        }

        function updatePreview() {
            const v1 = document.getElementById('sub1Select').value;
            const v2 = document.getElementById('sub2Select').value;
            const preview = document.getElementById('preview');
            const btn = document.getElementById('btnMerge');
            
            if (!v1 || !v2) {
                preview.innerHTML = 'S√©lectionnez deux sous-titres pour activer la fusion.';
                btn.disabled = true;
                return;
            }
            
            if (v1 === v2) {
                preview.innerHTML = '<span style="color:#ff6b6b;">‚ö†Ô∏è Choisissez deux sous-titres diff√©rents !</span>';
                btn.disabled = true;
                return;
            }
            
            const s1 = subtitles.find(s => s.Index == v1);
            const s2 = subtitles.find(s => s.Index == v2);
            
            preview.innerHTML = `
                <strong>Fusion pr√™te:</strong><br>
                <span style="color:#4CAF50;">‚Üë HAUT:</span> #${v1} ${(s1?.Language||'').toUpperCase()} (${s1?.Codec})<br>
                <span style="color:#2196F3;">‚Üì BAS:</span> #${v2} ${(s2?.Language||'').toUpperCase()} (${s2?.Codec})
            `;
            btn.disabled = false;
        }

        async function doMerge() {
            const btn = document.getElementById('btnMerge');
            const result = document.getElementById('result');
            
            const v1 = document.getElementById('sub1Select').value;
            const v2 = document.getElementById('sub2Select').value;
            const mode = document.getElementById('mergeMode').value;
            const tolerance = document.getElementById('tolerance').value;
            
            if (!currentMovie || !v1 || !v2) return;
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Fusion en cours...';
            result.innerHTML = '';
            
            try {
                const url = `${EMBY_URL}/EmbySubtitleMerger/Merge?api_key=${API_KEY}`;
                const body = {
                    VideoPath: currentMovie.Path,
                    PrimaryIndex: parseInt(v1),
                    SecondaryIndex: parseInt(v2),
                    Mode: mode,
                    ToleranceMs: parseInt(tolerance)
                };
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                
                if (data.Success) {
                    result.className = 'result success';
                    result.innerHTML = `
                        <strong>‚úÖ ${data.Message}</strong><br>
                        <span style="color:#888;">Fichier cr√©√©: ${data.OutputPath}</span><br>
                        <span style="color:#888;">${data.CueCount} sous-titres fusionn√©s</span>
                    `;
                } else {
                    result.className = 'result error';
                    result.innerHTML = `<strong>‚ùå Erreur:</strong> ${data.Error}`;
                }
            } catch (e) {
                result.className = 'result error';
                result.innerHTML = `<strong>‚ùå Erreur:</strong> ${e.message}`;
            }
            
            btn.disabled = false;
            btn.textContent = 'üîÄ Fusionner les sous-titres';
        }
    </script>
</body>
</html>


